<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Details - Lost & Found Baguio</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide@latest/font/lucide.css">
    <link rel="stylesheet" href="css/styles.css">
    <!-- Only including necessary CSS files for the new live chat system -->
    <link rel="stylesheet" href="css/form-debug.css"><!-- Added form debug CSS -->
    <link rel="stylesheet" href="css/emergency-modal.css"><!-- Added emergency modal CSS -->
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            color: #2563eb;
            text-decoration: none;
            margin-bottom: 2rem;
            font-weight: 500;
        }
        
        .back-link i {
            margin-right: 0.5rem;
        }
        
        .item-details-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        @media (min-width: 768px) {
            .item-details-layout {
                grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
            }
        }
        
        .item-image-container {
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            height: auto;
        }
        
        .item-image {
            width: auto;
            height: auto;
            min-width: 300px;
            min-height: 300px;
            max-width: 100%;
            max-height: 500px;
            object-fit: contain;
            padding: 5px;
        }
        
        .item-info {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        
        .item-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f172a;
            margin: 0;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-active {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status-claimed {
            background-color: #e0f2fe;
            color: #075985;
        }
        
        .info-group {
            margin-bottom: 1.5rem;
        }
        
        .info-label {
            font-weight: 600;
            color: #334155;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .info-value {
            color: #64748b;
        }
        
        .info-row {
            display: flex;
            margin-bottom: 0.75rem;
        }
        
        .info-row .info-label {
            width: 150px;
            margin-bottom: 0;
        }
        
        .actions {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        
        .btn-outline {
            background-color: white;
            border: 1px solid #2563eb;
            color: #2563eb;
        }
        
        .btn-outline:hover {
            background-color: #f8fafc;
        }
        
        .btn i {
            margin-right: 0.5rem;
        }
        
        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
            visibility: visible !important; /* Force visibility */
            opacity: 1 !important; /* Force opacity */
            align-items: center;
            justify-content: center;
        }
        
        /* Force modal display when active */
        .modal[style*="display: block"] {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
        }
        
        .close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #334155;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 1rem;
            box-sizing: border-box;
            display: block;
            margin-bottom: 0.5rem;
            background-color: #fff;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #93c5fd;
            box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.2);
        }
        
        .error-message {
            color: #b91c1c;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">
            <i data-lucide="arrow-left"></i>
            Back to All Items
        </a>
        
        <div class="item-details-layout" id="item-details">
            <div class="item-image-container">
                <img id="item-image" src="https://via.placeholder.com/600x450?text=Loading..." alt="Item" class="item-image">
            </div>
            
            <div class="item-info">
                <div class="item-header">
                    <h1 id="item-title" class="item-title">Loading...</h1>
                    <span id="item-status" class="status-badge status-active">Active</span>
                </div>
                
                <div class="info-group">
                    <span class="info-label">Description</span>
                    <p id="item-description" class="info-value">Loading item details...</p>
                </div>
                
                <div class="info-group">
                    <div class="info-row">
                        <span class="info-label">Category:</span>
                        <span id="item-category" class="info-value">Loading...</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Found Location:</span>
                        <span id="item-location" class="info-value">Loading...</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Date Found:</span>
                        <span id="item-date" class="info-value">Loading...</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Storage Location:</span>
                        <span id="item-storage-location" class="info-value">Loading...</span>
                    </div>
                </div>
                
                <div class="actions">
                    <button id="claim-btn" class="btn btn-primary" style="margin-right: 10px;">
                        <i data-lucide="check-circle"></i>
                        Claim This Item
                    </button>
                    <button id="contact-btn" class="btn btn-outline">
                        <i data-lucide="message-circle"></i>
                        Chat with Staff
                    </button>
                </div>
                
                <!-- Firebase integration for buttons -->
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('Setting up modal buttons with Firebase integration');
                    
                    // Claim Button
                    const claimBtn = document.getElementById('claim-btn');
                    if (claimBtn) {
                        claimBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            console.log('Claim button clicked');
                            document.getElementById('claim-modal').style.display = 'block';
                        });
                    }
                    
                    // Chat Button - Using new live chat implementation
                    const contactBtn = document.getElementById('contact-btn');
                    if (contactBtn) {
                        contactBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            console.log('Chat button clicked - using new live chat');
                            
                            // The chat widget from user-live-chat.js should already be initialized
                            // Just need to toggle it open
                            if (window.toggleChatWidget) {
                                window.toggleChatWidget();
                            } else {
                                console.error('Live chat system not properly loaded');
                                alert('Chat system is currently unavailable. Please try again later.');
                            }
                        });
                    }
                });
                </script>
            </div>
    
    <!-- New live chat system is implemented with user-live-chat.js -->
    
    <!-- Claim Modal -->
    <div id="claim-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('claim-modal').style.display='none';">&times;</span>
            <h2>Submit Claim</h2>
            <form id="claim-form" method="post" onsubmit="return false;">
                <div class="form-group">
                    <label for="claimant-name">Your Name</label>
                    <input type="text" id="claimant-name" name="claimant-name" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="claimant-email">Email</label>
                    <input type="email" id="claimant-email" name="claimant-email" placeholder="Enter your email address" required>
                </div>
                <div class="form-group">
                    <label for="claimant-phone">Phone Number</label>
                    <input type="tel" id="claimant-phone" name="claimant-phone" placeholder="Enter your phone number" required>
                </div>
                <div class="form-group">
                    <label for="claim-description">Proof of Ownership (Describe identifying details)</label>
                    <textarea id="claim-description" name="claim-description" rows="4" placeholder="Describe specific details about the item that prove your ownership" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Claim</button>
            </form>
        </div>
    </div>
    
    <!-- Removed old chat styles - using new live chat implementation instead -->
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- FIX AUTO MODAL - HIGHEST PRIORITY -->
    <script src="js/fix-auto-modal.js"></script>

    <!-- Firebase CDN Scripts - using version 9.22.2 which supports modular web v9 API -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    
    <!-- Emergency form fix script - HIGH PRIORITY -->
    <script src="js/emergency-form-fix.js"></script>
    
    <!-- App scripts that depend on Firebase -->
    <script src="js/icon-fix.js"></script>
    <script src="js/modal-fix.js"></script>
    <script src="js/messages.js"></script>
    <script src="js/firebase-messages.js"></script>
    <script src="js/firebase-item-details.js"></script>
    <script src="js/force-modal.js"></script>
    <script src="js/debug-modal.js"></script>
    <script src="js/form-fix.js"></script><!-- Added form fix script -->
    <script src="js/test-form.js"></script><!-- Added test form script -->
    <script src="js/user-live-chat.js"></script><!-- New live chat implementation -->
    <script src="js/user-chat-fix.js"></script><!-- Emergency fix for chat input visibility -->
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBGH1-fruNM0GPOLpOjfOIxHpLgqzt8fe0",
            authDomain: "lafsys.firebaseapp.com",
            projectId: "lafsys",
            storageBucket: "lafsys.appspot.com",
            messagingSenderId: "103945210522",
            appId: "1:103945210522:web:f5a51c84653a0cab10ed23",
            measurementId: "G-EJ2X0PTDNH"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Make Firebase services available
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing page');
            lucide.createIcons();
            
            // Get item ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get('id');
            console.log('Item ID from URL:', itemId);
            
            if (itemId) {
                // Load item details FIRST, then set up modals after data is loaded
                fetchItemDetails(itemId)
                    .then(() => {
                        console.log('Item details loaded, now setting up modals');
                        // Setup modal functionality AFTER item data is loaded
                        setupModals();
                        
                        // Direct button assignments as fallback
                        console.log('Adding direct button handlers');
                        document.getElementById('claim-btn').onclick = function() {
                            console.log('Claim button clicked (direct handler)');
                            document.getElementById('claim-modal').style.display = 'block';
                        };
                        
                        document.getElementById('contact-btn').onclick = function() {
                            console.log('Contact button clicked (direct handler)');
                            document.getElementById('contact-modal').style.display = 'block';
                        };
                    })
                    .catch(error => {
                        console.error('Error in initialization sequence:', error);
                    });
            } else {
                document.getElementById('item-title').textContent = 'Item Not Found';
                document.getElementById('item-description').textContent = 'No item ID provided in the URL.';
                setupModals(); // Still set up modals even without an item
            }
        });
        
        // Fetch item details from Firestore - returns a promise
        async function fetchItemDetails(itemId) {
            console.log('Fetching item details for ID:', itemId);
            try {
                const docRef = db.collection('items').doc(itemId);
                console.log('Created document reference');
                const doc = await docRef.get();
                console.log('Got document from Firestore:', doc.exists ? 'exists' : 'does not exist');
                
                if (doc.exists) {
                    const data = doc.data();
                    console.log('Item data:', data);
                    
                    // Update the UI with item details
                    document.getElementById('item-title').textContent = data.title || 'Untitled Item';
                    document.getElementById('item-description').textContent = data.description || 'No description available';
                    document.getElementById('item-category').textContent = data.category || 'Uncategorized';
                    document.getElementById('item-location').textContent = data.location || 'Unknown';
                    document.getElementById('item-storage-location').textContent = data.storageLocation || 'Not specified';
                    
                    // Format date
                    if (data.date) {
                        const dateObj = new Date(data.date);
                        document.getElementById('item-date').textContent = dateObj.toLocaleDateString();
                    } else {
                        document.getElementById('item-date').textContent = 'Unknown';
                    }
                    
                    // Set image
                    if (data.image) {
                        const imgElement = document.getElementById('item-image');
                        imgElement.src = data.image;
                        imgElement.alt = data.title || 'Item image';
                        
                        // Check if this is a data URL and log it
                        if (typeof data.image === 'string' && data.image.startsWith('data:image')) {
                            console.log('Using Data URL for image');
                            
                            // Add error handling for data URLs
                            imgElement.onerror = function() {
                                console.error('Error loading data URL image');
                                this.src = 'https://via.placeholder.com/800x600?text=Image+Error';
                            };
                        } else {
                            console.log('Using external URL for image:', data.image);
                        }
                    }
                    
                    // Set status
                    const statusBadge = document.getElementById('item-status');
                    if (data.status === 'claimed') {
                        statusBadge.textContent = 'Claimed';
                        statusBadge.className = 'status-badge status-claimed';
                        
                        // Disable claim button if item is claimed
                        document.getElementById('claim-btn').disabled = true;
                        document.getElementById('claim-btn').classList.add('btn-disabled');
                    } else {
                        statusBadge.textContent = 'Active';
                        statusBadge.className = 'status-badge status-active';
                    }
                    
                    // Store the item ID for the claim form
                    document.getElementById('claim-btn').dataset.itemId = itemId;
                    document.getElementById('contact-btn').dataset.itemId = itemId;
                    
                } else {
                    console.log("No such document!");
                    document.getElementById('item-title').textContent = 'Item Not Found';
                    document.getElementById('item-description').textContent = 'The requested item does not exist.';
                }
            } catch (error) {
                console.error("Error getting item:", error);
                document.getElementById('item-title').textContent = 'Error';
                document.getElementById('item-description').textContent = 'There was an error loading the item details.';
            }
        }
        
        // Setup modal functionality
        function setupModals() {
            console.log('Setting up modals');
            
            // Claim modal
            const claimModal = document.getElementById('claim-modal');
            const claimBtn = document.getElementById('claim-btn');
            const claimClose = claimModal.querySelector('.close');
            
            console.log('Claim button:', claimBtn);
            
            // Direct onclick handler for claim button
            claimBtn.onclick = function() {
                console.log('Claim button clicked');
                claimModal.style.display = 'block';
            };
            
            claimClose.onclick = function() {
                claimModal.style.display = 'none';
            };
            
            // Contact modal
            const contactModal = document.getElementById('contact-modal');
            const contactBtn = document.getElementById('contact-btn');
            const contactClose = contactModal.querySelector('.close');
            
            // Function to check for existing chats in Firestore
            async function checkForExistingChat(userEmail) {
                if (!firebase || !firebase.firestore || !userEmail) return null;
                
                try {
                    const db = firebase.firestore();
                    console.log(`Checking for existing chats for user: ${userEmail}`);
                    
                    // Query for chats where this user is a participant or has messages
                    const chatsQuery = await db.collection('chats')
                        .where('userInfo.' + userEmail, '!=', null)
                        .get();
                    
                    // Also check by email in case the chat was created differently
                    if (chatsQuery.empty) {
                        const threadsQuery = await db.collection('threads')
                            .doc(userEmail)
                            .get();
                            
                        if (threadsQuery.exists) {
                            console.log('Found thread in threads collection:', threadsQuery.id);
                            return {
                                id: threadsQuery.id,
                                adminId: 'admin@lafsys.gov',
                                ...threadsQuery.data()
                            };
                        }
                    }
                    
                    if (chatsQuery.empty) {
                        console.log('No existing chats found');
                        return null;
                    }
                    
                    // Get the most recent chat
                    let mostRecentChat = null;
                    let mostRecentTimestamp = 0;
                    
                    chatsQuery.forEach(doc => {
                        const chatData = doc.data();
                        const timestamp = chatData.lastTimestamp ? chatData.lastTimestamp.toDate().getTime() : 0;
                        
                        // Find the other participant (admin)
                        const adminId = chatData.participants && chatData.participants.find(id => 
                            id !== userEmail && (id.includes('admin') || id === 'admin@lafsys.gov'));
                        
                        if (timestamp > mostRecentTimestamp && adminId) {
                            mostRecentChat = {
                                id: doc.id,
                                adminId: adminId,
                                ...chatData
                            };
                            mostRecentTimestamp = timestamp;
                        }
                    });
                    
                    console.log('Most recent chat found:', mostRecentChat ? mostRecentChat.id : 'none');
                    return mostRecentChat;
                } catch (error) {
                    console.error('Error checking for existing chats:', error);
                    return null;
                }
            }
            
            console.log('Contact button:', contactBtn);
            
            // Direct onclick handler for contact button
            contactBtn.onclick = function() {
                console.log('Contact button clicked');
                
                // Use the ChatAuth system if available
                if (window.ChatAuth) {
                    console.log('Using ChatAuth system for chat');
                    const userIdentity = window.ChatAuth.getUserIdentity();
                    
                    if (userIdentity && userIdentity.name && userIdentity.email) {
                        console.log('User already authenticated:', userIdentity);
                        document.getElementById('contact-modal').style.display = 'block';
                        window.ChatAuth.restoreChatHistory(userIdentity);
                        
                        setTimeout(function() {
                            var chatInput = document.getElementById('chat-input');
                            if (chatInput) chatInput.focus();
                        }, 300);
                    } else {
                        console.log('User needs to authenticate first');
                        window.ChatAuth.showAuthModal();
                    }
                } else {
                    // Fallback to old behavior if ChatAuth isn't available
                    console.log('ChatAuth not available, using default behavior');
                    document.getElementById('contact-modal').style.display = 'block';
                    
                    setTimeout(function() {
                        var chatInput = document.getElementById('chat-input');
                        if (chatInput) chatInput.focus();
                    }, 300);
                }
            };
            
            contactClose.onclick = function() {
                contactModal.style.display = 'none';
            };
            
            // Close modals when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === claimModal) {
                    claimModal.style.display = 'none';
                }
                if (event.target === contactModal) {
                    contactModal.style.display = 'none';
                }
            });
            
            // Handle claim form submission
            const claimForm = document.getElementById('claim-form');
            claimForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const itemId = claimBtn.dataset.itemId;
                
                // Get input values
                const claimantName = document.getElementById('claimant-name').value;
                const claimantEmail = document.getElementById('claimant-email').value;
                const claimantPhone = document.getElementById('claimant-phone').value;
                const claimDescription = document.getElementById('claim-description').value;
                
                // Validate form fields
                if (!claimantName || !claimantEmail || !claimantPhone || !claimDescription) {
                    alert('Please fill in all fields');
                    return;
                }
                
                try {
                    // Add claim to Firestore using proper field names for Claims section
                    await db.collection('claims').add({
                        itemId: itemId,
                        claimantName: claimantName,
                        claimantEmail: claimantEmail,
                        claimantPhone: claimantPhone,
                        description: claimDescription,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log('Claim submitted successfully for item ID:', itemId);
                    
                    // Reset form
                    claimForm.reset();
                    
                    // Close modal and show success message
                    claimModal.style.display = 'none';
                    alert('Your claim has been submitted successfully. We will contact you soon.');
                    
                } catch (error) {
                    console.error("Error submitting claim:", error);
                    alert('There was an error submitting your claim. Please try again later.');
                }
            });
            
            // Setup chat functionality
            const chatInput = document.getElementById('chat-input');
            const sendMessageBtn = document.getElementById('send-message-btn');
            const chatMessages = document.getElementById('chat-messages');
            
            if (chatInput && sendMessageBtn && chatMessages) {
                console.log('Chat elements found, setting up handlers');
                
                // Function to add a message to the chat
                function addMessageToChat(text, isUser = true) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${isUser ? 'user-message' : 'staff-message'}`;
                    
                    const messageBubble = document.createElement('div');
                    messageBubble.className = 'message-bubble';
                    
                    const messagePara = document.createElement('p');
                    messagePara.textContent = text;
                    messageBubble.appendChild(messagePara);
                    
                    const messageInfo = document.createElement('div');
                    messageInfo.className = 'message-info';
                    messageInfo.textContent = isUser ? 'You • Just now' : 'Staff • Just now';
                    
                    messageDiv.appendChild(messageBubble);
                    messageDiv.appendChild(messageInfo);
                    
                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
                    
                    // Store in Firebase if needed
                    if (isUser) {
                        storeMessageInFirebase(text);
                    }
                }
                
                // Function to store message in Firebase using MessagesStore
                async function storeMessageInFirebase(text) {
                    try {
                        // Get item and user info
                        const itemId = document.getElementById('contact-btn').dataset.itemId;
                        const item = await db.collection('items').doc(itemId).get();
                        const itemData = item.exists ? item.data() : {};
                        const itemTitle = itemData.title || 'Unknown item';
                        
                        // Store user data in session storage to be remembered
                        let userName = sessionStorage.getItem('userName') || 'Visitor';
                        let userEmail = sessionStorage.getItem('userEmail') || `visitor_${Date.now()}@example.com`;
                        
                        // If we have window.MessagesStore with sendAsync, use that
                        if (window.MessagesStore?.sendAsync) {
                            await window.MessagesStore.sendAsync(userEmail, userName, text, userEmail);
                            console.log('Message sent via MessagesStore');
                            
                            // Send admin notification with item details
                            const adminMsg = `User asking about item: ${itemTitle} (ID: ${itemId})`;
                            setTimeout(() => {
                                window.MessagesStore.sendAsync(userEmail, 'System', adminMsg, 'admin@lafsys.gov');
                            }, 500);
                        } else {
                            // Legacy direct Firebase access
                            await db.collection('messages').add({
                                itemId: itemId,
                                from: userName,
                                email: userEmail,
                                subject: `Question about ${itemTitle}`,
                                body: text,
                                date: new Date().toISOString(),
                                unread: true
                            });
                            console.log('Message stored directly in Firebase');
                        }
                        
                        // Simulate staff response
                        setTimeout(() => {
                            addMessageToChat('Thanks for your message. A staff member will get back to you shortly.', false);
                        }, 1000);
                    } catch (error) {
                        console.error('Error storing message:', error);
                    }
                }
                
                // Send message button click handler
                sendMessageBtn.addEventListener('click', () => {
                    const messageText = chatInput.value.trim();
                    if (messageText) {
                        addMessageToChat(messageText);
                        chatInput.value = ''; // Clear input field
                    }
                });
                
                // Allow Enter key to send message
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessageBtn.click();
                    }
                });
                
                // Focus input when chat opens
                document.getElementById('contact-btn').addEventListener('click', () => {
                    setTimeout(() => chatInput.focus(), 300);
                });
            } else {
                console.error('Chat elements not found');
            }
        }
    </script>
<script>
// Extra script to make sure modals work
document.addEventListener('DOMContentLoaded', function() {
    console.log('Final modal fix script loaded');
    
    // Make sure claim button works
    document.getElementById('claim-btn').onclick = function() {
        console.log('Claim button clicked (direct handler)');
        document.getElementById('claim-modal').style.display = 'block';
    };
    
    // Make sure contact button works
    document.getElementById('contact-btn').onclick = function() {
        console.log('Contact button clicked (final handler)');
        
        // Use the ChatAuth system if available
        if (window.ChatAuth) {
            console.log('Using ChatAuth system for chat');
            const userIdentity = window.ChatAuth.getUserIdentity();
            
            if (userIdentity && userIdentity.name && userIdentity.email) {
                console.log('User already authenticated:', userIdentity);
                
                // Check Firestore for existing chats
                checkForExistingChat(userIdentity.email)
                    .then(existingChatData => {
                        if (existingChatData) {
                            console.log('Found existing chat:', existingChatData);
                            // Store current chat data for the chat modal
                            sessionStorage.setItem('currentChatId', existingChatData.id);
                            sessionStorage.setItem('adminId', existingChatData.adminId || 'admin@lafsys.gov');
                        }
                        
                        // Show the chat modal and restore history
                        document.getElementById('contact-modal').style.display = 'block';
                        window.ChatAuth.restoreChatHistory(userIdentity);
                        
                        // Refresh the thread to ensure we show all messages
                        if (window.setupThreadListener && document.getElementById('chat-messages')) {
                            window.setupThreadListener(userIdentity.email, document.getElementById('chat-messages'));
                        }
                        
                        setTimeout(function() {
                            const chatInput = document.getElementById('chat-input');
                            if (chatInput) chatInput.focus();
                        }, 300);
                    })
                    .catch(error => {
                        console.error('Error checking for existing chats:', error);
                        // Fall back to default behavior
                        document.getElementById('contact-modal').style.display = 'block';
                        window.ChatAuth.restoreChatHistory(userIdentity);
                    });
            } else {
                console.log('User needs to authenticate first');
                window.ChatAuth.showAuthModal();
            }
        } else {
            // Fallback to old behavior if ChatAuth isn't available
            console.log('ChatAuth not available, using default behavior');
            document.getElementById('contact-modal').style.display = 'block';
            
            setTimeout(function() {
                const chatInput = document.getElementById('chat-input');
                if (chatInput) chatInput.focus();
            }, 300);
        }
    };
    
    // Global functions for inline onclick attributes
    window.showClaimModal = function() {
        console.log('Global showClaimModal called');
        document.getElementById('claim-modal').style.display = 'block';
    };
    
    window.showChatModal = function() {
        console.log('Global showChatModal called');
        
        // Use the ChatAuth system if available
        if (window.ChatAuth) {
            console.log('Using ChatAuth system for chat');
            const userIdentity = window.ChatAuth.getUserIdentity();
            
            if (userIdentity && userIdentity.name && userIdentity.email) {
                console.log('User already authenticated:', userIdentity);
                
                // Check Firestore for existing chats
                checkForExistingChat(userIdentity.email)
                    .then(existingChatData => {
                        if (existingChatData) {
                            console.log('Found existing chat:', existingChatData);
                            // Store current chat data for the chat modal
                            sessionStorage.setItem('currentChatId', existingChatData.id);
                            sessionStorage.setItem('adminId', existingChatData.adminId || 'admin@lafsys.gov');
                        }
                        
                        // Show the chat modal and restore history
                        document.getElementById('contact-modal').style.display = 'block';
                        window.ChatAuth.restoreChatHistory(userIdentity);
                        
                        // Refresh the thread to ensure we show all messages
                        if (window.setupThreadListener && document.getElementById('chat-messages')) {
                            window.setupThreadListener(userIdentity.email, document.getElementById('chat-messages'));
                        }
                        
                        setTimeout(function() {
                            const chatInput = document.getElementById('chat-input');
                            if (chatInput) chatInput.focus();
                        }, 300);
                    })
                    .catch(error => {
                        console.error('Error checking for existing chats:', error);
                        // Fall back to default behavior
                        document.getElementById('contact-modal').style.display = 'block';
                        window.ChatAuth.restoreChatHistory(userIdentity);
                    });
            } else {
                console.log('User needs to authenticate first');
                window.ChatAuth.showAuthModal();
            }
        } else {
            // Fallback to old behavior if ChatAuth isn't available
            console.log('ChatAuth not available, using default behavior');
            document.getElementById('contact-modal').style.display = 'block';
            
            setTimeout(function() {
                var chatInput = document.getElementById('chat-input');
                if (chatInput) chatInput.focus();
            }, 300);
        }
    };
    
    // Fix all close buttons
    var closeButtons = document.querySelectorAll('.modal .close');
    closeButtons.forEach(function(btn) {
        btn.onclick = function() {
            var modal = this.closest('.modal');
            if (modal) modal.style.display = 'none';
        };
    });
    
    // Close modals when clicking outside
    window.onclick = function(event) {
        var modals = document.querySelectorAll('.modal');
        modals.forEach(function(modal) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    };
});
</script>
</body>
</html>
