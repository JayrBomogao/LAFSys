<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Item - Lost & Found Baguio</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide@latest/font/lucide.css">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            color: #2563eb;
            text-decoration: none;
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: #dcfce7;
            color: #166534;
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        @media (min-width: 768px) {
            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #334155;
        }
        
        .form-group.required label::after {
            content: '*';
            color: #ef4444;
            margin-left: 0.25rem;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #93c5fd;
            box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.2);
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        /* Image Upload */
        .image-upload-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
            position: relative;
            background-color: #f8fafc;
        }
        
        .image-upload-preview:hover {
            border-color: #93c5fd;
            background-color: #f0f9ff;
        }
        
        .image-upload-preview.has-image {
            border: none;
        }
        
        .image-upload-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .image-upload-text {
            text-align: center;
            padding: 1rem;
            color: #64748b;
        }
        
        .image-upload-input {
            display: none;
        }
        
        .image-upload-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            font-size: 1rem;
            border: 1px solid transparent;
        }
        
        .btn-primary {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        
        .btn-secondary {
            background-color: white;
            color: #2563eb;
            border: 1px solid #2563eb;
        }
        
        .btn-secondary:hover {
            background-color: #f8fafc;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        
        /* Firebase Status */
        .firebase-status {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: #22c55e;
            color: white;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="admin.html" class="back-link">
            <span>‚Üê</span> Back to Dashboard
        </a>
        
        <div class="header">
            <h1>Add New Lost Item</h1>
        </div>
        
        <form id="itemForm" class="card">
            <div>
                <h2 class="section-title">Item Information</h2>
                
                <div class="form-group">
                    <label>Item Photo</label>
                    <div class="image-upload-preview" id="imagePreview">
                        <div class="image-upload-text">
                            <span>üì§</span>
                            <div>Click to upload or drag and drop</div>
                            <div style="font-size: 0.75rem; margin-top: 0.5rem; color: #94a3b8;">
                                PNG, JPG, JPEG (max. 5MB)
                            </div>
                        </div>
                    </div>
                    <input type="file" id="imageUpload" class="image-upload-input" accept="image/*">
                    <div class="image-upload-actions">
                        <button type="button" class="btn btn-secondary btn-sm" id="uploadBtn">
                            Upload Image
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" id="removeImageBtn" style="display: none;">
                            Remove
                        </button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group required">
                        <label for="itemName">Item Name</label>
                        <input type="text" id="itemName" class="form-control" placeholder="e.g., Black Leather Wallet" required>
                    </div>
                    
                    <div class="form-group required">
                        <label for="itemCategory">Category</label>
                        <select id="itemCategory" class="form-control" required>
                            <option value="">Select a category</option>
                            <option value="wallet">Wallet/Purse</option>
                            <option value="phone">Mobile Phone</option>
                            <option value="laptop">Laptop/Tablet</option>
                            <option value="keys">Keys</option>
                            <option value="bag">Bag/Backpack</option>
                            <option value="clothing">Clothing</option>
                            <option value="jewelry">Jewelry</option>
                            <option value="documents">Documents</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group required">
                    <label for="itemDescription">Description</label>
                    <textarea id="itemDescription" class="form-control" placeholder="Provide a detailed description of the item, including any distinguishing features..." required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group required">
                        <label for="foundLocation">Found Location</label>
                        <input type="text" id="foundLocation" class="form-control" placeholder="e.g., Burnham Park, near the boat station" required>
                    </div>
                    
                    <div class="form-group required">
                        <label for="foundDate">Date Found</label>
                        <input type="date" id="foundDate" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="foundBy">Found By (Optional)</label>
                        <input type="text" id="foundBy" class="form-control" placeholder="Staff name or contact person">
                    </div>
                    
                    <div class="form-group">
                        <label for="storageLocation">Storage Location (Optional)</label>
                        <input type="text" id="storageLocation" class="form-control" placeholder="e.g., Front Desk, Security Office">
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="publishBtn">
                    Publish Item
                </button>
            </div>
        </form>
    </div>
    

    <!-- Firebase CDN Scripts - using version 9.22.2 which supports modular web v9 API -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="js/firebase-debug.js"></script>
    <script src="js/image-compressor.js"></script>
    
    <!-- Firebase Config -->
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBGH1-fruNM0GPOLpOjfOIxHpLgqzt8fe0",
            authDomain: "lafsys.firebaseapp.com",
            projectId: "lafsys",
            storageBucket: "lafsys.appspot.com", // Correct storage bucket format
            messagingSenderId: "103945210522",
            appId: "1:103945210522:web:f5a51c84653a0cab10ed23",
            measurementId: "G-EJ2X0PTDNH"
        };
        
        console.log('Initializing Firebase with config:', firebaseConfig);
        
        // Check if the configuration seems valid
        const configCheck = window.firebaseDebug.checkConfig(firebaseConfig);
        console.log('Config check:', configCheck);
        
        // Declare variables in global scope for access from other functions
        let db, storage, auth;
        
        try {
            // Initialize Firebase
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log('Firebase initialized successfully');
            } else {
                console.log('Firebase already initialized, using existing instance');
            }
            
            // Make Firebase services available
            db = firebase.firestore();
            console.log('Firestore initialized');
            
            storage = firebase.storage();
            console.log('Storage initialized');
            
            auth = firebase.auth();
            console.log('Auth initialized');
            
            
        } catch (error) {
            console.error('Error initializing Firebase:', error);
            alert('Error initializing Firebase: ' + error.message);
        }
        
        // Check if we're in edit mode
        const urlParams = new URLSearchParams(window.location.search);
        const isEditMode = urlParams.get('edit') === 'true';
        const itemId = urlParams.get('id');
        let originalImageUrl = ''; // Store original image URL for edit mode
        
        // Function to load item data for editing
        async function loadItemForEdit(id) {
            try {
                console.log('Loading item for edit:', id);
                const db = firebase.firestore();
                const doc = await db.collection('items').doc(id).get();
                
                if (!doc.exists) {
                    alert('Item not found!');
                    window.location.href = 'admin.html';
                    return;
                }
                
                const item = doc.data();
                console.log('Loaded item:', item);
                
                // Update page title
                document.querySelector('h1').textContent = 'Edit Item';
                document.querySelector('.status-badge').textContent = '‚úèÔ∏è Editing';
                
                // Populate form fields
                document.getElementById('itemName').value = item.title || '';
                document.getElementById('itemCategory').value = item.category || '';
                document.getElementById('itemDescription').value = item.description || '';
                document.getElementById('foundLocation').value = item.location || '';
                
                // Handle date field
                if (item.date) {
                    let dateValue;
                    if (item.date.toDate) {
                        // Firestore Timestamp
                        dateValue = item.date.toDate().toISOString().split('T')[0];
                    } else if (item.date instanceof Date) {
                        dateValue = item.date.toISOString().split('T')[0];
                    } else {
                        dateValue = item.date.split('T')[0];
                    }
                    document.getElementById('foundDate').value = dateValue;
                }
                
                document.getElementById('foundBy').value = item.foundBy || '';
                document.getElementById('storageLocation').value = item.storageLocation || '';
                
                // Handle disposal date
                if (item.disposalDate) {
                    let disposalValue;
                    if (item.disposalDate.toDate) {
                        disposalValue = item.disposalDate.toDate().toISOString().split('T')[0];
                    } else if (item.disposalDate instanceof Date) {
                        disposalValue = item.disposalDate.toISOString().split('T')[0];
                    } else {
                        disposalValue = item.disposalDate.split('T')[0];
                    }
                    document.getElementById('disposalDate').value = disposalValue;
                }
                
                // Load image if exists and store the original URL
                if (item.image && item.image !== 'https://via.placeholder.com/400x300?text=No+Image') {
                    originalImageUrl = item.image; // Store original image URL
                    const imagePreview = document.getElementById('imagePreview');
                    imagePreview.innerHTML = `<img src="${item.image}" style="max-width: 100%; max-height: 100%;">`;
                    imagePreview.classList.add('has-image');
                    document.getElementById('removeImageBtn').style.display = 'inline-flex';
                } else {
                    originalImageUrl = 'https://via.placeholder.com/400x300?text=No+Image';
                }
                
                // Update submit button text
                document.querySelector('button[type="submit"]').textContent = 'Update Item';
                
            } catch (error) {
                console.error('Error loading item:', error);
                alert('Error loading item: ' + error.message);
            }
        }
        
        // Image upload functionality
        document.addEventListener('DOMContentLoaded', async function() {
            // Set max date to today for the date input
            const foundDateInput = document.getElementById('foundDate');
            const today = new Date().toISOString().split('T')[0];
            foundDateInput.setAttribute('max', today);
            
            // Add validation message for future dates
            foundDateInput.addEventListener('input', function() {
                const selectedDate = this.value;
                if (selectedDate > today) {
                    this.setCustomValidity('Date cannot be in the future');
                } else {
                    this.setCustomValidity('');
                }
            });
            
            const imageUpload = document.getElementById('imageUpload');
            const imagePreview = document.getElementById('imagePreview');
            const uploadBtn = document.getElementById('uploadBtn');
            const removeImageBtn = document.getElementById('removeImageBtn');
            
            // If in edit mode, load the item data
            if (isEditMode && itemId) {
                await loadItemForEdit(itemId);
            }
            
            // Trigger file input when clicking on preview area
            imagePreview.addEventListener('click', function() {
                imageUpload.click();
            });
            
            // Trigger file input when clicking on upload button
            uploadBtn.addEventListener('click', function() {
                imageUpload.click();
            });
            
            // Handle file selection
            imageUpload.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // Clear existing content
                        imagePreview.innerHTML = '';
                        
                        // Create image element
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.maxWidth = '100%';
                        img.style.maxHeight = '100%';
                        
                        // Add image to preview
                        imagePreview.appendChild(img);
                        imagePreview.classList.add('has-image');
                        
                        // Show remove button
                        removeImageBtn.style.display = 'inline-flex';
                    };
                    
                    reader.readAsDataURL(this.files[0]);
                }
            });
            
            // Handle image removal
            removeImageBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering file input
                
                // Clear file input
                imageUpload.value = '';
                
                // Reset preview
                imagePreview.innerHTML = `
                    <div class="image-upload-text">
                        <span>üì§</span>
                        <div>Click to upload or drag and drop</div>
                        <div style="font-size: 0.75rem; margin-top: 0.5rem; color: #94a3b8;">
                            PNG, JPG, JPEG (max. 5MB)
                        </div>
                    </div>
                `;
                imagePreview.classList.remove('has-image');
                
                // Hide remove button
                this.style.display = 'none';
            });
            
            // Function to save item to database
            async function saveItemToDatabase(itemData, isEditMode, itemId, statusDiv) {
                try {
                    statusDiv.textContent = 'Saving to database...';
                    
                    if (isEditMode && itemId) {
                        // Update existing item
                        console.log('Updating item in Firestore...');
                        
                        // Remove createdAt for updates, add updatedAt instead
                        delete itemData.createdAt;
                        itemData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        
                        await db.collection('items').doc(itemId).update(itemData);
                        console.log('Document updated with ID:', itemId);
                        
                        statusDiv.style.background = '#22c55e';
                        statusDiv.textContent = 'Item updated successfully!';
                        
                        setTimeout(() => {
                            window.location.href = 'admin.html';
                        }, 500);
                        
                        return itemId; // Return the ID for background processing
                    } else {
                        // Add new item to Firestore
                        console.log('Adding item to Firestore...');
                        
                        const docRef = await db.collection('items').add(itemData);
                        console.log('Document added with ID:', docRef.id);
                        
                        statusDiv.style.background = '#22c55e';
                        statusDiv.textContent = 'Item added successfully!';
                        
                        setTimeout(() => {
                            window.location.href = 'admin.html';
                        }, 500);
                        
                        return docRef.id; // Return the new ID for background processing
                    }
                } catch (error) {
                    console.error('Error saving to database:', error);
                    statusDiv.style.background = '#ef4444';
                    statusDiv.textContent = 'Error: ' + error.message;
                    return null; // Return null if there's an error
                }
            }
            
            // Form submission handler - completely redone for reliability
            const itemForm = document.getElementById('itemForm');
            
            itemForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Validate date isn't in the future
                const foundDateInput = document.getElementById('foundDate');
                const selectedDate = foundDateInput.value;
                const today = new Date().toISOString().split('T')[0];
                
                if (selectedDate > today) {
                    alert('Error: Date found cannot be in the future.');
                    foundDateInput.focus();
                    return;
                }
                
                // Show submission status
                const statusDiv = document.createElement('div');
                statusDiv.style.position = 'fixed';
                statusDiv.style.top = '10px';
                statusDiv.style.left = '50%';
                statusDiv.style.transform = 'translateX(-50%)';
                statusDiv.style.padding = '10px';
                statusDiv.style.background = '#3b82f6';
                statusDiv.style.color = 'white';
                statusDiv.style.borderRadius = '5px';
                statusDiv.style.zIndex = '9999';
                statusDiv.textContent = 'Processing form submission...';
                document.body.appendChild(statusDiv);
                
                try {
                    // Get form data
                    const itemData = {
                        title: document.getElementById('itemName').value,
                        category: document.getElementById('itemCategory').value,
                        description: document.getElementById('itemDescription').value,
                        location: document.getElementById('foundLocation').value,
                        date: document.getElementById('foundDate').value,
                        foundBy: document.getElementById('foundBy').value,
                        storageLocation: document.getElementById('storageLocation').value,
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    console.log('Form data collected');
                    
                    // Get image file if any
                    const imageFile = imageUpload.files[0] || null;
                    
                    // No image case
                    if (!imageFile) {
                        console.log('No image to upload');
                        
                        // If editing and no new image uploaded, keep the original image
                        if (isEditMode && originalImageUrl) {
                            itemData.image = originalImageUrl;
                        } else {
                            itemData.image = 'https://via.placeholder.com/400x300?text=No+Image';
                        }
                        
                        // Save to database directly
                        await saveItemToDatabase(itemData, isEditMode, itemId, statusDiv);
                        return;
                    }
                    
                    // Fast upload with optimized approach
                    statusDiv.textContent = 'Processing image...';
                    
                    try {
                        // First create a data URL for immediate display
                        const reader = new FileReader();
                        reader.readAsDataURL(imageFile);
                        
                        reader.onload = function(event) {
                            const dataUrl = event.target.result;
                            
                            // Immediately save with the data URL for speed
                            console.log('Using data URL for immediate display');
                            itemData.image = dataUrl;
                            
                            // Start saving to database with data URL
                            statusDiv.textContent = 'Saving item...';
                            saveItemToDatabase(itemData, isEditMode, itemId, statusDiv).then(function(savedDocId) {
                                // After saving, upload to Firebase Storage in background
                                try {
                                    console.log('Starting Firebase upload in background');
                                    const fileName = `items/${Date.now()}_${imageFile.name}`;
                                    const storageRef = firebase.storage().ref();
                                    const imageRef = storageRef.child(fileName);
                                    
                                    imageRef.put(imageFile).then(function() {
                                        return imageRef.getDownloadURL();
                                    }).then(function(downloadURL) {
                                        console.log('Firebase upload completed, URL:', downloadURL);
                                        
                                        // Get the correct document ID that was just saved
                                        const docId = isEditMode ? itemId : savedDocId;
                                        console.log('Updating image URL in document:', docId);
                                        
                                        if (!docId) {
                                            console.error('No document ID available for update');
                                            return;
                                        }
                                        
                                        // Update the item in database with the permanent URL
                                        return db.collection('items').doc(docId).update({
                                            image: downloadURL
                                        });
                                    }).catch(function(error) {
                                        console.error('Background upload failed:', error);
                                    });
                                } catch (uploadError) {
                                    console.error('Error starting background upload:', uploadError);
                                    // This won't affect the user experience since the item is already saved
                                }
                            }).catch(function(error) {
                                console.error('Error in save item callback:', error);
                            });
                        };
                        
                        reader.onerror = function() {
                            console.error('Error reading file as data URL');
                            statusDiv.style.background = '#ef4444';
                            statusDiv.textContent = 'Error processing image';
                        };
                    } catch (imageProcessError) {
                        console.error('Error in image processing:', imageProcessError);
                        statusDiv.style.background = '#ef4444';
                        statusDiv.textContent = 'Error: ' + imageProcessError.message;
                    }
                } catch (error) {
                    console.error('Error in form processing:', error);
                    statusDiv.style.background = '#ef4444';
                    statusDiv.textContent = 'Error: ' + error.message;
                }
            });
        });
    </script>
</body>
</html>
