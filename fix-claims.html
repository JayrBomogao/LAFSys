<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Claims</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 { color: #2563eb; }
        button {
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            margin: 5px 10px 5px 0;
        }
        button:hover { background: #1d4ed8; }
        pre {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
            max-height: 300px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #dcfce7; color: #166534; }
        .error { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <h1>Fix Claims Page</h1>
    <p>This utility creates sample data and helps troubleshoot the Claims page.</p>
    
    <div class="card">
        <h2>Test Firebase Connection</h2>
        <button id="test-firebase">Test Firebase</button>
        <div id="firebase-result" class="result"></div>
    </div>
    
    <div class="card">
        <h2>Create Sample Data</h2>
        <button id="create-sample">Create Sample Item & Claim</button>
        <button id="clear-all" style="background-color: #dc2626;">Clear All Data</button>
        <div id="sample-result" class="result"></div>
    </div>
    
    <div class="card">
        <h2>Utility Functions</h2>
        <button id="view-claims">View All Claims</button>
        <button id="view-items">View All Items</button>
        <div id="util-result" class="result"></div>
    </div>
    
    <div class="card">
        <h2>Console Output</h2>
        <pre id="console-output">// Console output will appear here</pre>
        <button id="clear-console">Clear Console</button>
    </div>
    
    <div style="margin-top: 20px;">
        <a href="claims.html" target="_blank">Open Claims Page</a> | 
        <a href="admin.html" target="_blank">Open Admin Dashboard</a>
    </div>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    
    <script>
        // Capture console output
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function() {
            originalLog.apply(console, arguments);
            const args = Array.from(arguments).join(' ');
            consoleOutput.textContent += args + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        console.error = function() {
            originalError.apply(console, arguments);
            const args = Array.from(arguments).join(' ');
            consoleOutput.textContent += 'ERROR: ' + args + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        // Initialize Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyBGH1-fruNM0GPOLpOjfOIxHpLgqzt8fe0",
          authDomain: "lafsys.firebaseapp.com",
          projectId: "lafsys",
          storageBucket: "lafsys.appspot.com",
          messagingSenderId: "103945210522",
          appId: "1:103945210522:web:f5a51c84653a0cab10ed23",
          measurementId: "G-EJ2X0PTDNH"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log('Firebase initialized');
        
        // Helper function to show result
        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = isError ? 'result error' : 'result success';
            }
        }
        
        // Test Firebase connection
        document.getElementById('test-firebase').addEventListener('click', async () => {
            try {
                console.log('Testing Firebase connection...');
                
                // Try to write a test document
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                const docRef = await db.collection('_test').add({
                    timestamp,
                    message: 'Connection test ' + new Date().toISOString()
                });
                
                console.log('Firebase connection successful! Test doc ID:', docRef.id);
                showResult('firebase-result', `Firebase connection successful! Test document created with ID: ${docRef.id}`);
                
                // Clean up
                await db.collection('_test').doc(docRef.id).delete();
                console.log('Test document deleted');
                
            } catch (error) {
                console.error('Firebase connection test failed:', error);
                showResult('firebase-result', `Firebase connection failed: ${error.message}`, true);
            }
        });
        
        // Create sample data
        document.getElementById('create-sample').addEventListener('click', async () => {
            try {
                console.log('Creating sample data...');
                showResult('sample-result', 'Creating sample data...');
                
                // Create a sample item
                const itemRef = await db.collection('items').add({
                    title: "Sample Wallet",
                    description: "This is a sample black leather wallet with credit cards and cash.",
                    category: "personal",
                    location: "Burnham Park Main Entrance",
                    date: firebase.firestore.FieldValue.serverTimestamp(),
                    status: "active",
                    image: "https://images.unsplash.com/photo-1541339907198-e08756dedf3f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                    foundBy: "Park Staff",
                    storageLocation: "Admin Office",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('Created sample item with ID:', itemRef.id);
                
                // Create a sample claim
                const claimRef = await db.collection('claims').add({
                    itemId: itemRef.id,
                    claimantName: "Juan Dela Cruz",
                    claimantEmail: "juan.delacruz@example.com",
                    claimantPhone: "+63 912 345 6789",
                    description: "The wallet contains my driver's license, two credit cards (BDO and BPI), and approximately â‚±2,000 in cash.",
                    status: "pending",
                    notes: "I can provide identification to verify ownership.",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('Created sample claim with ID:', claimRef.id);
                
                showResult('sample-result', `Sample data created successfully!\nItem ID: ${itemRef.id}\nClaim ID: ${claimRef.id}`);
                
            } catch (error) {
                console.error('Error creating sample data:', error);
                showResult('sample-result', `Error creating sample data: ${error.message}`, true);
            }
        });
        
        // Clear all data
        document.getElementById('clear-all').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete ALL items and claims? This cannot be undone!')) {
                return;
            }
            
            try {
                console.log('Clearing all data...');
                showResult('sample-result', 'Clearing all data...');
                
                // Delete claims first
                const claimsSnapshot = await db.collection('claims').get();
                console.log(`Found ${claimsSnapshot.size} claims to delete`);
                
                const deleteClaimPromises = [];
                claimsSnapshot.forEach(doc => {
                    deleteClaimPromises.push(db.collection('claims').doc(doc.id).delete());
                });
                
                // Delete items
                const itemsSnapshot = await db.collection('items').get();
                console.log(`Found ${itemsSnapshot.size} items to delete`);
                
                const deleteItemPromises = [];
                itemsSnapshot.forEach(doc => {
                    deleteItemPromises.push(db.collection('items').doc(doc.id).delete());
                });
                
                // Wait for all deletes to complete
                await Promise.all([...deleteClaimPromises, ...deleteItemPromises]);
                
                console.log('All data cleared successfully');
                showResult('sample-result', `All data cleared successfully!\nDeleted ${claimsSnapshot.size} claims and ${itemsSnapshot.size} items.`);
                
            } catch (error) {
                console.error('Error clearing data:', error);
                showResult('sample-result', `Error clearing data: ${error.message}`, true);
            }
        });
        
        // View claims
        document.getElementById('view-claims').addEventListener('click', async () => {
            try {
                console.log('Fetching claims...');
                showResult('util-result', 'Fetching claims...');
                
                const claimsSnapshot = await db.collection('claims').get();
                
                if (claimsSnapshot.empty) {
                    console.log('No claims found');
                    showResult('util-result', 'No claims found in the database');
                    return;
                }
                
                const claims = [];
                claimsSnapshot.forEach(doc => {
                    claims.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log(`Found ${claims.length} claims:`, claims);
                
                const claimsList = claims.map(claim => 
                    `- ID: ${claim.id}\n  Item: ${claim.itemId}\n  Status: ${claim.status}\n  Claimant: ${claim.claimantName || 'Unknown'}\n`
                ).join('\n');
                
                showResult('util-result', `Found ${claims.length} claims:\n\n${claimsList}`);
                
            } catch (error) {
                console.error('Error fetching claims:', error);
                showResult('util-result', `Error fetching claims: ${error.message}`, true);
            }
        });
        
        // View items
        document.getElementById('view-items').addEventListener('click', async () => {
            try {
                console.log('Fetching items...');
                showResult('util-result', 'Fetching items...');
                
                const itemsSnapshot = await db.collection('items').get();
                
                if (itemsSnapshot.empty) {
                    console.log('No items found');
                    showResult('util-result', 'No items found in the database');
                    return;
                }
                
                const items = [];
                itemsSnapshot.forEach(doc => {
                    items.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log(`Found ${items.length} items:`, items);
                
                const itemsList = items.map(item => 
                    `- ID: ${item.id}\n  Title: ${item.title || 'Untitled'}\n  Status: ${item.status || 'unknown'}\n  Location: ${item.location || 'Unknown'}\n`
                ).join('\n');
                
                showResult('util-result', `Found ${items.length} items:\n\n${itemsList}`);
                
            } catch (error) {
                console.error('Error fetching items:', error);
                showResult('util-result', `Error fetching items: ${error.message}`, true);
            }
        });
        
        // Clear console
        document.getElementById('clear-console').addEventListener('click', () => {
            consoleOutput.textContent = '// Console cleared\n';
        });
        
        console.log('Fix-claims utility loaded and ready');
    </script>
</body>
</html>
