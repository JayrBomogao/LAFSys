<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost & Found ‚Äì Baguio City</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide@latest/font/lucide.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Item cards styling */
        .items-section {
            margin-top: 2rem;
        }
        
        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .items-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .item-card {
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .item-image {
            height: 180px;
            overflow: hidden;
            position: relative;
            background-color: #f1f5f9;
        }
        
        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .item-content {
            padding: 1.25rem;
        }
        
        .item-title {
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 0.5rem;
            color: #0f172a;
        }
        
        .item-category {
            display: inline-block;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: #e0f2fe;
            color: #075985;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.75rem;
        }
        
        .item-details {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .item-details div {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        
        .item-details i {
            margin-right: 0.5rem;
        }
        
        .item-actions {
            margin-top: 1rem;
            display: flex;
            justify-content: flex-end;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        
        .btn i {
            margin-right: 0.375rem;
        }
        
        .loading, .error, .no-items {
            padding: 2rem;
            text-align: center;
            color: #64748b;
            background-color: #f8fafc;
            border-radius: 0.5rem;
        }
        
        .error {
            color: #b91c1c;
            background-color: #fee2e2;
        }
        
        .error-card {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #f87171;
            min-height: 100px;
        }
        
        /* Responsive fixes */
        @media (max-width: 768px) {
            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }
        }
        
        @media (max-width: 480px) {
            .items-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <script type="module" src="js/firebase.js"></script>
    <header class="header">
        <div class="logo">
            <h1>Lost & Found ‚Äì Baguio City</h1>
            <p>Find your missing items</p>
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search items...">
            <button id="searchButton" class="search-btn"><i data-lucide="search"></i></button>
            <button id="imageSearchBtn" class="btn-outline" title="Search by image">
                <i data-lucide="image"></i>
                <span>Search by Image</span>
            </button>
        </div>
        <a href="admin.html" class="admin-btn">Admin Panel</a>
    </header>

    <main class="container">
        <div class="filters">
            <select id="statusFilter" class="filter-select">
                <option value="all">All Items</option>
                <option value="active">Active</option>
                <option value="claimed">Claimed</option>
                <option value="soon">Disposal Soon</option>
            </select>
        </div>

        <section class="items-section">
            <div class="items-header">
                <h2 class="items-title">Recently Found Items</h2>
                <button id="refresh-items" class="btn btn-primary">
                    <i data-lucide="refresh-cw"></i> Refresh
                </button>
            </div>
            <div class="items-grid" id="items-container">
                <!-- Items will be loaded here by JavaScript -->
            </div>
        </section>
    </main>

    <!-- Item Details Modal -->
    <div id="itemDetailsModal" class="modal">
        <div class="modal-content large">
            <span class="close">&times;</span>
            <div class="modal-body">
                <div class="modal-image">
                    <img id="modalItemImage" src="" alt="Item">
                </div>
                <div class="modal-content-right">
                    <div class="modal-header">
                        <h2 id="modalItemTitle"></h2>
                        <span id="modalItemStatus" class="status-badge"></span>
                    </div>
                    
                    <div class="tabs">
                        <button class="tab-button active" data-tab="details">Item Details</button>
                        <button class="tab-button" data-tab="chat">Chat with Staff</button>
                    </div>
                    
                    <div class="tab-content">
                        <!-- Item Details Tab -->
                        <div id="details-tab" class="tab-pane active">
                            <div class="form-group">
                                <h3>Description</h3>
                                <p id="modalItemDescription"></p>
                            </div>
                            <div class="item-details">
                                <h3>Item Details</h3>
                                <div class="detail-row">
                                    <span class="detail-label">Category:</span>
                                    <span id="modalItemCategory"></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Location Found:</span>
                                    <span id="modalItemLocation"></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Date Found:</span>
                                    <span id="modalItemDate"></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Disposal Date:</span>
                                    <span id="modalItemDisposalDate"></span>
                                </div>
                            </div>
                            <button id="claimItemBtn" class="btn">Claim This Item</button>
                        </div>
                        
                        <!-- Chat Tab -->
                        <div id="chat-tab" class="tab-pane">
                            <div id="chatMessages" class="chat-messages">
                                <!-- Messages will be added here by JavaScript -->
                            </div>
                            <div class="chat-input">
                                <input type="text" id="chatMessageInput" placeholder="Type your message...">
                                <button id="sendMessageBtn" class="btn">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Claim Modal -->
    <div id="claimModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Submit Claim</h2>
            <form id="claimForm">
                <div class="form-group">
                    <label for="claimantName">Your Name</label>
                    <input type="text" id="claimantName" required>
                </div>
                <div class="form-group">
                    <label for="claimantEmail">Email</label>
                    <input type="email" id="claimantEmail" required>
                </div>
                <div class="form-group">
                    <label for="claimDescription">Description of Ownership</label>
                    <textarea id="claimDescription" rows="4" required></textarea>
                </div>
                <button type="submit" class="btn">Submit Claim</button>
            </form>
        </div>
    </div>

    <!-- Image Search Modal -->
    <div id="imageSearchModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Search by Image</h2>
            <div class="image-upload-container">
                <div id="imagePreview" class="image-preview">
                    <p>No image selected</p>
                </div>
                <div class="upload-actions">
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                    <button id="uploadBtn" class="btn">Choose Image</button>
                    <button id="findMatchesBtn" class="btn" disabled>Find Matches</button>
                </div>
            </div>
            <div id="searchResults" class="search-results">
                <!-- Search results will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Floating Inquiry Button & Form -->
    <div class="floating-inquiry-container">
        <button id="inquiryButton" class="inquiry-button">
            <i data-lucide="message-circle" width="24" height="24"></i>
            <span>Need Help?</span>
        </button>
        
        <div id="inquiryPanel" class="inquiry-panel">
            <div class="inquiry-header">
                <h3>Can't Find Your Item?</h3>
                <button class="close-inquiry">&times;</button>
            </div>
            <div class="inquiry-body">
                <p>Send us a message and we'll help you find it.</p>
                <form id="inquiryForm">
                    <div class="form-group">
                        <input type="text" id="inquiryName" placeholder="Your Name" required>
                    </div>
                    <div class="form-group">
                        <input type="email" id="inquiryEmail" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <textarea id="inquiryMessage" placeholder="Describe your missing item..." required rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn inquiry-submit">Send Message</button>
                </form>
                <div id="inquirySuccess" class="inquiry-success" style="display: none;">
                    <i data-lucide="check-circle" width="20" height="20"></i>
                    <span>Message sent! We'll respond soon.</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="js/icon-fix.js"></script>
    
    <!-- Firebase CDN Scripts - using version 9.22.2 which supports modular web v9 API -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    
    <!-- Firebase Config (Non-module version for testing) -->
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBGH1-fruNM0GPOLpOjfOIxHpLgqzt8fe0",
            authDomain: "lafsys.firebaseapp.com",
            projectId: "lafsys",
            storageBucket: "lafsys.appspot.com", // Fixed storage bucket URL
            messagingSenderId: "103945210522",
            appId: "1:103945210522:web:f5a51c84653a0cab10ed23",
            measurementId: "G-EJ2X0PTDNH"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Make Firebase services available
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();
        
        // Fetch and display items from Firestore using a simpler approach
        async function fetchAndDisplayItems() {
            try {
                console.log('Starting to fetch items');
                // Get the items container
                const itemsContainer = document.getElementById('items-container');
                if (!itemsContainer) {
                    console.error('Items container not found');
                    return;
                }
                
                // Clear the container with loading message
                itemsContainer.innerHTML = '<div class="loading">Loading items...</div>';
                
                // Get items from Firestore
                console.log('Querying Firestore');
                const querySnapshot = await db.collection('items').get();
                console.log('Query completed, document count:', querySnapshot.size);
                
                if (querySnapshot.empty) {
                    console.log('No items found in Firestore');
                    itemsContainer.innerHTML = '<div class="no-items">No items found in database</div>';
                    return;
                }
                
                // Start building HTML for all items at once (safer approach)
                let allItemsHTML = '';
                
                // Process each document and build HTML string
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    console.log('Processing item:', id);
                    
                    // Format date
                    const dateFound = data.date ? new Date(data.date) : null;
                    const formattedDate = dateFound ? dateFound.toLocaleDateString() : 'Unknown date';
                    
                    // Default image if none
                    const imageUrl = data.image || 'https://via.placeholder.com/300x200?text=No+Image';
                    
                    // Build HTML for this item
                    allItemsHTML += `
                        <div class="item-card" data-item-id="${id}">
                            <div class="item-image">
                                <img src="${imageUrl}" alt="${data.title || 'Unknown item'}" onerror="this.src='https://via.placeholder.com/300x200?text=Image+Error'">
                            </div>
                            <div class="item-content">
                                <h3 class="item-title">${data.title || 'Unnamed Item'}</h3>
                                <div class="item-category">${data.category || 'Uncategorized'}</div>
                                <div class="item-details">
                                    <div>üìç ${data.location || 'Unknown location'}</div>
                                    <div>üìÖ ${formattedDate}</div>
                                </div>
                                <div class="item-actions">
                                    <button class="btn btn-primary view-item" onclick="window.location.href='item-details.html?id=${id}'">
                                        üëÅÔ∏è View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Update the container with all items at once
                itemsContainer.innerHTML = allItemsHTML;
                
                console.log(`Successfully loaded ${querySnapshot.size} items`);
                
            } catch (error) {
                console.error('Error fetching items:', error);
                const itemsContainer = document.getElementById('items-container');
                if (itemsContainer) {
                    itemsContainer.innerHTML = `<div class="error">Error loading items: ${error.message}</div>`;
                }
            }
        }
        
        // View item details function (now used via onclick in HTML)        
        function viewItemDetails(itemId) {
            console.log('Viewing item:', itemId);
            window.location.href = `item-details.html?id=${itemId}`;
        }
        
        // Test connection with visible indicator
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch and display items after checking connection
            fetchAndDisplayItems();
            
            // Add refresh button functionality if it exists
            const refreshBtn = document.getElementById('refresh-items');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', fetchAndDisplayItems);
            }
            
            // Create status indicator
            const statusDiv = document.createElement('div');
            statusDiv.style.position = 'fixed';
            statusDiv.style.bottom = '10px';
            statusDiv.style.right = '10px';
            statusDiv.style.padding = '10px';
            statusDiv.style.background = 'yellow';
            statusDiv.style.borderRadius = '5px';
            statusDiv.textContent = 'Testing Firebase connection...';
            document.body.appendChild(statusDiv);
            
            // Test Firestore write operation
            try {
                // Try to add a test document
                db.collection('test_collection').add({
                    message: 'Test document',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then((docRef) => {
                    statusDiv.style.background = 'green';
                    statusDiv.style.color = 'white';
                    statusDiv.textContent = '‚úì Firebase Connected: Write successful';
                    console.log('Firebase write successful! Document ID:', docRef.id);
                    
                    // Create a test UI to show Firestore status
                    const testContainer = document.createElement('div');
                    testContainer.style.position = 'fixed';
                    testContainer.style.top = '50%';
                    testContainer.style.left = '50%';
                    testContainer.style.transform = 'translate(-50%, -50%)';
                    testContainer.style.padding = '20px';
                    testContainer.style.background = 'white';
                    testContainer.style.border = '1px solid #ddd';
                    testContainer.style.borderRadius = '8px';
                    testContainer.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    testContainer.style.zIndex = '1000';
                    testContainer.style.maxWidth = '500px';
                    testContainer.style.width = '80%';
                    
                    testContainer.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">Firebase Connection Test</h3>
                            <button id="closeTestBtn" style="border: none; background: none; cursor: pointer; font-size: 18px;">&times;</button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <p><span style="color: green; font-weight: bold;">‚úì</span> Firebase App initialized</p>
                            <p><span style="color: green; font-weight: bold;">‚úì</span> Firestore write successful</p>
                            <p>Document ID: <code>${docRef.id}</code></p>
                        </div>
                        <button id="readTestBtn" style="background: #4285F4; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Test Firestore Read</button>
                    `;
                    
                    document.body.appendChild(testContainer);
                    
                    // Close button handler
                    document.getElementById('closeTestBtn').addEventListener('click', () => {
                        testContainer.remove();
                    });
                    
                    // Read test button handler
                    document.getElementById('readTestBtn').addEventListener('click', () => {
                        db.collection('test_collection').doc(docRef.id).get()
                            .then((doc) => {
                                if (doc.exists) {
                                    alert('Read successful! Data: ' + JSON.stringify(doc.data()));
                                } else {
                                    alert('No document found!');
                                }
                            })
                            .catch((error) => {
                                alert('Error reading document: ' + error.message);
                            });
                    });
                    
                })
                .catch((error) => {
                    statusDiv.style.background = 'red';
                    statusDiv.style.color = 'white';
                    statusDiv.textContent = '‚úó Firebase Error: ' + error.message;
                    console.error('Firebase write error:', error);
                });
            } catch (error) {
                statusDiv.style.background = 'red';
                statusDiv.style.color = 'white';
                statusDiv.textContent = '‚úó Firebase Error: ' + error.message;
                console.error('Firebase error:', error);
            }
        });
    </script>
    
    <!-- Keep original scripts for now, we'll migrate them one by one -->
    <script src="js/data.js"></script>
    <script src="js/messages.js"></script>
    <script src="js/modal.js"></script>
    <script src="js/imageSearch.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
